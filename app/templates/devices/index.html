{% extends "base.html" %}

{% block title %}设备管理 - NetManagerX{% endblock %}
{% block page_title %}设备管理{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">首页</a></li>
<li class="breadcrumb-item active">设备管理</li>
{% endblock %}

{% block content %}
<!-- 设备统计卡片 -->
<div class="row mb-3">
    <div class="col-lg-3 col-6">
        <div class="small-box bg-info">
            <div class="inner">
                <h3>{{ devices.total }}</h3>
                <p>总设备数</p>
            </div>
            <div class="icon">
                <i class="fas fa-network-wired"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-success">
            <div class="inner">
                <h3>{{ devices.items | selectattr('status', 'equalto', 'online') | list | length }}</h3>
                <p>在线设备</p>
            </div>
            <div class="icon">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-danger">
            <div class="inner">
                <h3>{{ devices.items | selectattr('status', 'equalto', 'offline') | list | length }}</h3>
                <p>离线设备</p>
            </div>
            <div class="icon">
                <i class="fas fa-times-circle"></i>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-warning">
            <div class="inner">
                <h3>{{ groups | length }}</h3>
                <p>设备组</p>
            </div>
            <div class="icon">
                <i class="fas fa-layer-group"></i>
            </div>
        </div>
    </div>
</div>

<!-- 设备列表 -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-list mr-1"></i>
            设备列表
        </h3>
        <div class="card-tools">
            <a href="{{ url_for('devices.add') }}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus mr-1"></i>添加设备
            </a>
            <a href="{{ url_for('devices.groups') }}" class="btn btn-secondary btn-sm">
                <i class="fas fa-layer-group mr-1"></i>设备组管理
            </a>
        </div>
    </div>
    <div class="card-body">
        <!-- 筛选器 -->
        <div class="row mb-3">
            <div class="col-md-3">
                <select class="form-control" id="groupFilter" onchange="filterDevices()">
                    <option value="">全部分组</option>
                    {% for group in groups %}
                    <option value="{{ group.id }}" {% if current_group_id == group.id %}selected{% endif %}>
                        {{ group.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-control" id="statusFilter" onchange="filterDevices()">
                    <option value="">全部状态</option>
                    <option value="online" {% if current_status == 'online' %}selected{% endif %}>在线</option>
                    <option value="offline" {% if current_status == 'offline' %}selected{% endif %}>离线</option>
                    <option value="error" {% if current_status == 'error' %}selected{% endif %}>错误</option>
                    <option value="unknown" {% if current_status == 'unknown' %}selected{% endif %}>未知</option>
                </select>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="搜索设备名称或IP地址..." id="searchInput">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchDevices()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 设备表格 -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th width="40">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th>设备名称</th>
                        <th>IP地址</th>
                        <th>设备类型</th>
                        <th>连接类型</th>
                        <th>状态</th>
                        <th>设备组</th>
                        <th>最后检查</th>
                        <th width="150">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices.items %}
                    <tr>
                        <td>
                            <input type="checkbox" class="device-checkbox" value="{{ device.id }}">
                        </td>
                        <td>
                            <a href="{{ url_for('devices.detail', device_id=device.id) }}" class="text-decoration-none">
                                {{ device.name }}
                            </a>
                        </td>
                        <td>{{ device.ip_address }}</td>
                        <td>
                            <span class="badge badge-secondary">
                                {% if device.device_type.value == 'cisco_router' %}
                                    Cisco路由器
                                {% elif device.device_type.value == 'cisco_switch' %}
                                    Cisco交换机
                                {% elif device.device_type.value == 'cisco_asa' %}
                                    Cisco ASA
                                {% elif device.device_type.value == 'cisco_wlc' %}
                                    Cisco WLC
                                {% else %}
                                    {{ device.device_type.value }}
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-info">
                                {{ device.connection_type.value.upper() }}
                            </span>
                        </td>
                        <td>
                            {% if device.status.value == 'online' %}
                                <span class="badge badge-success">在线</span>
                            {% elif device.status.value == 'offline' %}
                                <span class="badge badge-danger">离线</span>
                            {% elif device.status.value == 'error' %}
                                <span class="badge badge-warning">错误</span>
                            {% else %}
                                <span class="badge badge-secondary">未知</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if device.group %}
                                <span class="badge badge-light">{{ device.group.name }}</span>
                            {% else %}
                                <span class="text-muted">无分组</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if device.last_checked %}
                                {{ device.last_checked.strftime('%Y-%m-%d %H:%M') }}
                            {% else %}
                                <span class="text-muted">从未检查</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('devices.detail', device_id=device.id) }}" 
                                   class="btn btn-info btn-sm" title="查看详情">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('devices.edit', device_id=device.id) }}" 
                                   class="btn btn-warning btn-sm" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-success btn-sm" onclick="testConnection({{ device.id }})" title="测试连接">
                                    <i class="fas fa-plug"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteDevice({{ device.id }})" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            暂无设备数据
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        {% if devices.pages > 1 %}
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted">
                显示第 {{ devices.page }} 页，共 {{ devices.pages }} 页，总计 {{ devices.total }} 条记录
            </div>
            <nav>
                <ul class="pagination pagination-sm">
                    {% if devices.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('devices.index', page=devices.prev_num) }}">上一页</a>
                        </li>
                    {% endif %}
                    
                    {% for page_num in devices.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != devices.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('devices.index', page=page_num) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if devices.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('devices.index', page=devices.next_num) }}">下一页</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- 批量操作 -->
<div class="card mt-3" id="batchOperations" style="display: none;">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-tasks mr-1"></i>
            批量操作
        </h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <select class="form-control" id="batchAction">
                    <option value="">选择操作</option>
                    <option value="test_connection">测试连接</option>
                    <option value="backup_config">备份配置</option>
                    <option value="show_version">显示版本</option>
                </select>
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary" onclick="executeBatchAction()">
                    <i class="fas fa-play mr-1"></i>执行
                </button>
                <button class="btn btn-secondary" onclick="clearSelection()">
                    <i class="fas fa-times mr-1"></i>取消选择
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 设备筛选
function filterDevices() {
    const groupId = document.getElementById('groupFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    let url = new URL(window.location);
    if (groupId) {
        url.searchParams.set('group_id', groupId);
    } else {
        url.searchParams.delete('group_id');
    }
    
    if (status) {
        url.searchParams.set('status', status);
    } else {
        url.searchParams.delete('status');
    }
    
    window.location.href = url.toString();
}

// 设备搜索
function searchDevices() {
    const keyword = document.getElementById('searchInput').value;
    if (keyword.trim()) {
        // 这里可以实现客户端搜索或发送到服务器
        console.log('搜索关键词:', keyword);
    }
}

// 全选/取消全选
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.device-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateBatchOperations();
}

// 更新批量操作显示
function updateBatchOperations() {
    const checkedBoxes = document.querySelectorAll('.device-checkbox:checked');
    const batchOperations = document.getElementById('batchOperations');
    
    if (checkedBoxes.length > 0) {
        batchOperations.style.display = 'block';
    } else {
        batchOperations.style.display = 'none';
    }
}

// 清除选择
function clearSelection() {
    document.getElementById('selectAll').checked = false;
    document.querySelectorAll('.device-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateBatchOperations();
}

// 执行批量操作
function executeBatchAction() {
    const action = document.getElementById('batchAction').value;
    const checkedBoxes = document.querySelectorAll('.device-checkbox:checked');
    
    if (!action) {
        alert('请选择要执行的操作');
        return;
    }
    
    if (checkedBoxes.length === 0) {
        alert('请选择至少一个设备');
        return;
    }
    
    const deviceIds = Array.from(checkedBoxes).map(cb => cb.value);
    
    if (confirm(`确定要对 ${deviceIds.length} 个设备执行 ${action} 操作吗？`)) {
        // 发送批量操作请求
        fetch('/devices/bulk-action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: action,
                device_ids: deviceIds.join(',')
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('批量操作执行成功');
                location.reload();
            } else {
                alert('批量操作执行失败: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('批量操作执行失败');
        });
    }
}

// 测试设备连接
function testConnection(deviceId) {
    if (confirm('确定要测试此设备的连接吗？')) {
        fetch(`/devices/${deviceId}/test-connection`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('连接测试成功');
                location.reload();
            } else {
                alert('连接测试失败: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('连接测试失败');
        });
    }
}

// 删除设备
function deleteDevice(deviceId) {
    if (confirm('确定要删除此设备吗？此操作不可恢复！')) {
        fetch(`/devices/${deviceId}/delete`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('删除失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('删除失败');
        });
    }
}

// 监听复选框变化
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.device-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateBatchOperations);
    });
});
</script>
{% endblock %}
